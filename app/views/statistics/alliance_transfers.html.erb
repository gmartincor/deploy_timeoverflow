<div class="alliance-statistics-container">
    <div class="statistics-header">
        <h1 class="page-title">
            <i class="fas fa-handshake header-icon"></i>
            <%= t 'global.statistics' %>: <%= t '.alliance_transfers' %>
        </h1>
    </div>

    <% if @no_alliances %>
        <div class="alert alert-info alliance-alert">
            <i class="fas fa-info-circle"></i>
            <%= t '.no_alliances' %>
        </div>
    <% else %>
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <% if @target_organization %>
                    <div class="organization-header">
                        <h2 class="organization-title">
                            <i class="fas fa-building"></i>
                            <%= t('.alliance_with', org: @target_organization.name) %>
                        </h2>
                    </div>
                <% end %>
                
                <div class="filters-section">
                    <form class="row g-3 align-items-end">
                        <div class="col-12 col-md-4">
                            <label for="target_organization_id" class="form-label filter-label">
                                <i class="fas fa-filter"></i>
                                <%= t '.filter_by_organization' %>
                            </label>
                            <select name="target_organization_id" id="target_organization_id" class="form-control form-select-styled">
                                <option value=""><%= t '.all_organizations' %></option>
                                <% @allied_organizations.each do |org| %>
                                    <option value="<%= org.id %>" <%= 'selected' if @target_organization&.id == org.id %>><%= org.name %></option>
                                <% end %>
                            </select>
                        </div>
                        <div class="col-12 col-md-3">
                            <label for="from" class="form-label filter-label">
                                <i class="fas fa-calendar-day"></i>
                                <%= t '.from_date' %>
                            </label>
                            <input class="form-control date-input" type="date" name="from" value="<%= params[:from] %>">
                        </div>
                        <div class="col-12 col-md-3">
                            <label for="to" class="form-label filter-label">
                                <i class="fas fa-calendar-check"></i>
                                <%= t '.to_date' %>
                            </label>
                            <input class="form-control date-input" type="date" name="to" value="<%= params[:to] %>">
                        </div>
                        <div class="col-12 col-md-2">
                            <button class="btn btn-secondary" type="submit">
                                <i class="fas fa-search"></i>
                                <%= t '.apply_filters' %>
                            </button>
                        </div>
                    </form>
                </div>

                <div class="summary-section">
                    <h3 class="section-title">
                        <i class="fas fa-exchange-alt"></i>
                        <%= t '.transfers_summary' %>
                    </h3>
                    <div class="table-responsive table-container">
                        <table class="table table-hover alliance-table">
                            <thead class="table-header">
                                <tr>
                                    <th><i class="fas fa-building"></i> <%= t '.organization' %></th>
                                    <th class="text-center"><i class="fas fa-arrow-right text-danger"></i> <%= t '.outgoing_transfers' %></th>
                                    <th class="text-center"><i class="fas fa-arrow-left text-success"></i> <%= t '.incoming_transfers' %></th>
                                    <th class="text-center"><i class="fas fa-clock text-danger"></i> <%= t '.outgoing_hours' %></th>
                                    <th class="text-center"><i class="fas fa-clock text-success"></i> <%= t '.incoming_hours' %></th>
                                    <th class="text-center"><i class="fas fa-chart-line"></i> <%= t '.total_transfers' %></th>
                                </tr>
                            </thead>
                            <tbody>
                                <% @transfers_summary.each do |org_id, data| %>
                                    <tr class="table-row">
                                        <td class="organization-name">
                                            <%= link_to data[:name], organization_path(org_id), class: "org-link" %>
                                        </td>
                                        <td class="text-center outgoing-data">
                                            <span class="badge bg-danger rounded-pill"><%= data[:outgoing_count] %></span>
                                        </td>
                                        <td class="text-center incoming-data">
                                            <span class="badge bg-success rounded-pill"><%= data[:incoming_count] %></span>
                                        </td>
                                        <td class="text-center hours-data">
                                            <span class="text-danger fw-bold"><%= data[:outgoing_hours] %></span>
                                        </td>
                                        <td class="text-center hours-data">
                                            <span class="text-success fw-bold"><%= data[:incoming_hours] %></span>
                                        </td>
                                        <td class="text-center total-data">
                                            <span class="badge bg-primary rounded-pill"><%= data[:total_transfers] %></span>
                                        </td>
                                    </tr>
                                <% end %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12 col-lg-6">
                <div class="card shadow-sm chart-card">
                    <div class="card-body">
                        <h3 class="card-title">
                            <i class="fas fa-balance-scale"></i>
                            <%= t '.balance_chart' %>
                        </h3>
                        <div id="balance-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="card shadow-sm chart-card">
                    <div class="card-body">
                        <h3 class="card-title">
                            <i class="fas fa-chart-area"></i>
                            <%= t '.transfers_over_time' %>
                        </h3>
                        <div id="time-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            $(function () {
                var balanceData = <%= raw @balance_by_org.map { |_, data| 
                    balance = data[:balance].round(2)
                    if balance >= 0
                        { 
                            y: balance,
                            name: data[:name],
                            color: '#27ae60'
                        }
                    else
                        {
                            y: balance,
                            name: data[:name],
                            color: '#e74c3c'
                        }
                    end
                }.to_json %>;
                
                $('#balance-chart').highcharts({
                    chart: {
                        type: 'column'
                    },
                    title: {
                        text: '<%= t ".balance_with_allied_organizations" %>'
                    },
                    xAxis: {
                        categories: <%= raw @balance_by_org.map { |_, data| data[:name] }.to_json %>,
                        crosshair: true
                    },
                    yAxis: {
                        title: {
                            text: '<%= t ".hours" %>'
                        }
                    },
                    tooltip: {
                        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                            '<td style="padding:0"><b>{point.y:.2f} <%= t ".hours" %></b></td></tr>',
                        footerFormat: '</table>',
                        shared: true,
                        useHTML: true
                    },
                    plotOptions: {
                        column: {
                            pointPadding: 0.2,
                            borderWidth: 0,
                            colorByPoint: true
                        }
                    },
                    series: [{
                        name: '<%= t ".balance" %>',
                        data: balanceData
                    }]
                });

                <% if @target_organization %>
                    <% org_data = @transfers_by_month[@target_organization.id] %>
                    <% if org_data %>
                        var months = <%= raw org_data[:months].keys.to_json %>;
                        var outgoingData = <%= raw org_data[:months].values.map { |v| v[:outgoing] }.to_json %>;
                        var incomingData = <%= raw org_data[:months].values.map { |v| v[:incoming] }.to_json %>;
                        var balanceData = <%= raw org_data[:months].values.map { |v| v[:balance] }.to_json %>;
                        
                        $('#time-chart').highcharts({
                            chart: {
                                type: 'column'
                            },
                            title: {
                                text: '<%= t ".time_evolution_with", org: @target_organization.name %>'
                            },
                            xAxis: {
                                categories: months,
                                crosshair: true
                            },
                            yAxis: {
                                title: {
                                    text: '<%= t ".hours" %>'
                                }
                            },
                            tooltip: {
                                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                                pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                                    '<td style="padding:0"><b>{point.y:.2f} <%= t ".hours" %></b></td></tr>',
                                footerFormat: '</table>',
                                shared: true,
                                useHTML: true
                            },
                            plotOptions: {
                                column: {
                                    pointPadding: 0.2,
                                    borderWidth: 0
                                }
                            },
                            series: [{
                                name: '<%= t ".outgoing" %>',
                                color: '#e74c3c',
                                data: outgoingData
                            }, {
                                name: '<%= t ".incoming" %>',
                                color: '#27ae60',
                                data: incomingData
                            }, {
                                name: '<%= t ".balance" %>',
                                color: '#3498db',
                                data: balanceData
                            }]
                        });
                    <% end %>
                <% else %>
                    $('#time-chart').highcharts({
                        chart: {
                            type: 'column'
                        },
                        title: {
                            text: '<%= t ".select_organization_for_details" %>'
                        },
                        subtitle: {
                            text: '<%= t ".select_organization_subtitle" %>'
                        },
                        xAxis: {
                            type: 'category'
                        },
                        yAxis: {
                            title: {
                                text: '<%= t ".total_transfers" %>'
                            }
                        },
                        legend: {
                            enabled: false
                        },
                        tooltip: {
                            headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                            pointFormat: '<tr><td style="padding:0"><b>{point.y:.0f} <%= t ".transfers" %></b></td></tr>',
                            footerFormat: '</table>',
                            useHTML: true
                        },
                        plotOptions: {
                            series: {
                                borderWidth: 0,
                                dataLabels: {
                                    enabled: true,
                                    format: '{point.y:.0f}'
                                }
                            }
                        },
                        series: [{
                            name: '<%= t ".total_transfers" %>',
                            colorByPoint: true,
                            colors: ['#27ae60', '#3498db', '#e74c3c', '#f39c12', '#8e44ad', '#16a085', '#e67e22', '#2c3e50'],
                            data: <%= raw @transfers_summary.map { |org_id, data| { name: data[:name], y: data[:total_transfers] } }.to_json %>
                        }]
                    });
                <% end %>
            });
        </script>
    <% end %>
</div>
